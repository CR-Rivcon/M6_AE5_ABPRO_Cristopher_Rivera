{% extends "eventos/base.html" %}

{% block title %}Registrar Evento{% endblock %}

{% block content %}
<div class="row">
	<div class="col-lg-10 col-xl-8">
		<h1 class="h3 mb-4">Registrar Evento</h1>

		<form method="post" novalidate>
			{% csrf_token %}

			{% if evento_form.non_field_errors %}
				<div class="alert alert-danger">
					{{ evento_form.non_field_errors }}
				</div>
			{% endif %}

			{% include "eventos/_evento_fields.html" with evento_form=evento_form %}

			<hr class="my-4">
			<h2 class="h5 mb-3">Participantes</h2>

			{{ formset.management_form }}

			<div id="participantes-container">
				{% for form in formset.forms %}
					{% include "eventos/_participante_form.html" with form=form %}
				{% endfor %}
			</div>

			<template id="empty-form-template">
				{% include "eventos/_participante_form.html" with form=formset.empty_form %}
			</template>

			<div class="d-flex gap-2 mt-2 mb-4">
				<button type="button" class="btn btn-outline-secondary" id="add-participante">Agregar participante</button>
			</div>

			<div class="d-grid d-sm-flex gap-2">
				<button type="submit" class="btn btn-primary">Guardar</button>
				<button type="reset" class="btn btn-light">Limpiar</button>
			</div>
		</form>
	</div>
	<div class="col-lg-2"></div>
	</div>
{% endblock %}

{% block extra_js %}
<script>
	(function () {
		const addBtn = document.getElementById('add-participante');
		const container = document.getElementById('participantes-container');
		const totalForms = document.getElementById('id_participante_set-TOTAL_FORMS') || document.querySelector('input[name$="-TOTAL_FORMS"]');
		const template = document.getElementById('empty-form-template');

		if (!addBtn || !container || !totalForms || !template) return;

		addBtn.addEventListener('click', function () {
			const formIndex = parseInt(totalForms.value, 10);
			const newNode = template.content.cloneNode(true);
			// Reemplazar __prefix__ por el índice actual
			container.appendChild(newNode);
			const fragment = container.lastElementChild; // último agregado
			const regex = new RegExp('__prefix__', 'g');
			fragment.innerHTML = fragment.innerHTML.replace(regex, String(formIndex));
			totalForms.value = formIndex + 1;
		});
	})();
</script>
{% endblock %}


